# Docker image
# Build a Docker image to deploy, run, or push to a container registry.
# Add steps that use Docker Compose, tag images, push to a registry, run an image, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

#trigger:
#- master
#- release-1.0

#pr:
#- master
#- release-1.0

jobs:
- job: BuildLinuxBasedWindows
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: |
      sudo docker pull $(imageName)
      sudo docker run --name electrumsv-wine-builder-cont -v $PWD:/opt/wine64/drive_c/electrum --rm --workdir /opt/wine64/drive_c/electrum/contrib/build-wine electrumsv/electrumsv-wine-builder-img ./build.sh
      pushd contrib/build-wine/dist
      # We cannot write to the 'dist' directory, so need to write them elsewhere.
      sha256sum *.exe > $(Build.Repository.LocalPath)/windows-hashes.txt
      popd
    displayName: 'Windows build'
    continueOnError: false
  - task: CopyFiles@2
    inputs:
      contents: |
        windows-hashes.txt
        contrib/build-wine/dist/?(*.exe|*.txt)
      targetFolder: $(Build.ArtifactStagingDirectory)
      flattenFolders: true
      OverWrite: true
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'Windows build files'
      targetPath: $(Build.ArtifactStagingDirectory)
  variables:
    imageName: 'docker.io/electrumsv/electrumsv-wine-builder-img:latest'
- job: BuildPythonPackages
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: |
      sudo -H  pip install --upgrade pip
      ./contrib/make_packages
      ./contrib/make_tgz
      pushd dist
      # We cannot write to the 'dist' directory, so need to write them elsewhere.
      sha256sum * > $(Build.Repository.LocalPath)/package-hashes.txt
      popd
    displayName: 'Build Python packages'
    continueOnError: false
  - task: CopyFiles@2
    inputs:
      contents: dist/?(*.zip|*.gz|*.txt)
      targetFolder: $(Build.ArtifactStagingDirectory)
      flattenFolders: true
      OverWrite: true
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'Python package files'
      targetPath: $(Build.ArtifactStagingDirectory)
- job: BuildMacOS
  pool:
    vmImage: 'macOS-10.13'
  steps:
  - script: |
      brew install gettext && brew link gettext --force
      ./contrib/osx/make_osx
    continueOnError: false
    displayName: 'Build MacOS binaries'
