parameters:
  name: ''  # defaults for any parameters that aren't specified
  vmImage: ''
  pythonVersion: ''

jobs:
- job: ${{ parameters.name }}
  pool:
    vmImage: ${{ parameters.vmImage }}
  steps:
  - script: |
      # When you paste this, please make sure the indentation is preserved
      # Fail out if any setups fail
      # https://developercommunity.visualstudio.com/comments/598392/view.html
      set -e

      # Delete old Pythons
      rm -rf $AGENT_TOOLSDIRECTORY/Python/3.7.3

      # Download new Pythons
      azcopy --recursive \
        --source https://vstsagenttools.blob.core.windows.net/tools/hostedtoolcache/linux/Python/3.7.2 \
        --destination $AGENT_TOOLSDIRECTORY/Python/3.7.2

      # Install new Pythons
      original_directory=$PWD
      setups=$(find $AGENT_TOOLSDIRECTORY/Python -name setup.sh)
      for setup in $setups; do
          chmod +x $setup;
          cd $(dirname $setup);
          ./$(basename $setup);
          cd $original_directory;
      done;
    displayName: 'Workaround: roll back Python versions'
  - task: UsePythonVersion@0
    inputs:
      versionSpec: ${{ parameters.pythonVersion }}
      addToPath: true
      architecture: x64
  - template: prepare-general-environment.yml
  - script: |
      python3 -m pip install pytest pytest-cov
      python3 -m pytest --doctest-modules --junitxml=junit/test-results.xml --cov=electrumsv --cov-report=xml --cov-report=html electrumsv/tests
    displayName: 'Test with pytest'
  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: '**/test-*.xml'
      testRunTitle: 'Publish test results for Python ${{ parameters.pythonVersion }}'
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
      reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'